<!-- payment.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Các thẻ meta, link CSS như trước -->
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Restoran - Payment</title>
  <link
    crossorigin="anonymous"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
    rel="stylesheet"
  />
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    rel="stylesheet"
  />
  <style>
    /* Các kiểu CSS như trước */
    /* ... */
  </style>
</head>
<body>
  <div class="container">
    <div class="row">
      <!-- Shipping Information Form -->
      <div class="col-md-7">
        <h2 class="text-primary">Restoran</h2>
        <form id="order-form">
          <h4>Shipping Information</h4>
          <!-- Country Selection Dropdown -->
          <div class="mb-3">
            <label class="form-label" for="country">Country <span class="text-danger">*</span></label>
            <select class="form-select" id="country" required>
              <option value="">--- Select Country ---</option>
              <option value="Vietnam">Vietnam</option>
              <option value="USA">USA</option>
              <option value="Japan">Japan</option>
              <!-- Add other countries if needed -->
            </select>
          </div>
          <!-- Fields for Vietnam -->
          <div id="vietnam-address" class="vietnam-address">
            <div class="mb-3">
              <label class="form-label" for="city">Province/City <span class="text-danger">*</span></label>
              <select class="form-select" id="city" required>
                <option value="">--- Select Province/City ---</option>
                <!-- Provinces/Cities will be added via JavaScript -->
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label" for="district">District (optional)</label>
              <select class="form-select" id="district" disabled>
                <option value="">--- Select District ---</option>
                <!-- Districts will be added via JavaScript -->
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label" for="ward">Ward (optional)</label>
              <select class="form-select" id="ward" disabled>
                <option value="">--- Select Ward ---</option>
                <!-- Wards will be added via JavaScript -->
              </select>
            </div>
          </div>
          <!-- Fields for Other Countries -->
          <div id="general-address" class="general-address">
            <div class="mb-3">
              <label class="form-label" for="address-general">Address <span class="text-danger">*</span></label>
              <input
                class="form-control"
                id="address-general"
                type="text"
                placeholder="Address"
                required
              />
            </div>
          </div>
          <!-- Other Fields -->
          <div class="mb-3">
            <label class="form-label" for="email">Email <span class="text-danger">*</span></label>
            <input
              class="form-control"
              id="email"
              type="email"
              placeholder="Email"
              required
            />
          </div>
          <div class="mb-3">
            <label class="form-label" for="name">Full Name <span class="text-danger">*</span></label>
            <input
              class="form-control"
              id="name"
              type="text"
              placeholder="Full Name"
              required
            />
          </div>
          <div class="mb-3">
            <label class="form-label" for="phone">Phone Number <span class="text-danger">*</span></label>
            <div class="input-group">
              <div class="country-code-wrapper me-2" style="flex: 0 0 180px">
                <select class="form-select" id="country-code" required>
                  <option value="">---Select Country Code---</option>
                  <option value="+84" data-flag="img/co_vn.png">Vietnam (+84)</option>
                  <option value="+1" data-flag="img/co_usa.png">USA (+1)</option>
                  <option value="+81" data-flag="img/co_japan.jpg">Japan (+81)</option>
                  <!-- Add other countries if needed -->
                </select>
              </div>
              <input
                class="form-control"
                id="phone"
                type="text"
                placeholder="Phone Number"
                required
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label" for="note">Note <span class="text-danger">*</span></label>
            <textarea
              class="form-control"
              id="note"
              rows="3"
              placeholder="Note"
              required
            ></textarea>
          </div>
          <button class="btn btn-primary mt-3" id="place-order" type="submit">
            PLACE ORDER
          </button>
        </form>
      </div>
      <!-- Cart and Payment -->
      <div class="col-md-5">
        <div class="order-summary">
          <h4>Shipping</h4>
          <div class="alert alert-info">
            Please enter shipping information
          </div>
          <h4>Payment</h4>
          <div class="form-check">
            <input
              class="form-check-input"
              id="cod"
              name="payment"
              type="radio"
              value="COD"
              checked
            />
            <label class="form-check-label" for="cod">
              Cash on Delivery (COD)
            </label>
            <i class="fas fa-money-bill-wave ms-2"></i>
          </div>
          <h4 class="mt-4">
            Order (<span id="item-count">0</span> products)
          </h4>
          <div id="cartItemsContainer">
            <!-- Cart items will be displayed here -->
          </div>
          <div class="mb-3">
            <div class="input-group">
              <input
                class="form-control"
                id="discount-code"
                type="text"
                placeholder="Enter discount code"
              />
              <button class="btn btn-primary" id="apply-discount">
                Apply
              </button>
            </div>
          </div>
          <div class="mb-3">
            <p class="mb-0">Subtotal</p>
            <p class="mb-0 subtotal-price" id="subtotal">0₫</p>
          </div>
          <div class="mb-3">
            <p class="mb-0">Shipping Fee</p>
            <p class="mb-0 shipping-fee-price" id="shipping-fee">-</p>
          </div>
          <div class="mb-3 totals">
            <p class="mb-0">Total</p>
            <p class="mb-0 total-price" id="total">0₫</p>
          </div>

          <a class="back-to-cart" href="menu.html">Back to Cart</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Successful Modal -->
  <div
    class="modal fade"
    id="orderSuccessModal"
    tabindex="-1"
    aria-labelledby="orderSuccessModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="orderSuccessModalLabel">
            Order Successful
          </h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <p>Thank you for ordering at Restoran!</p>
          <p>
            We will contact you as soon as possible to confirm your order.
          </p>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-primary"
            data-bs-dismiss="modal"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Order Successful Modal End -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- JavaScript cho payment.html -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Định nghĩa các biến địa chỉ
      const vietnamAddress = document.getElementById("vietnam-address");
      const generalAddress = document.getElementById("general-address");

      // Cart data từ localStorage
      const cartItems = JSON.parse(localStorage.getItem("cartItems")) || [];
      let totalAmount = parseInt(localStorage.getItem("totalAmount")) || 0;
      let discount = 0;

      const cartItemsContainer = document.getElementById("cartItemsContainer");
      const itemCountSpan = document.getElementById("item-count");
      const subtotalP = document.getElementById("subtotal");
      const shippingFeeP = document.getElementById("shipping-fee");
      const totalP = document.getElementById("total");
      const applyDiscountButton = document.getElementById("apply-discount");
      const discountCodeInput = document.getElementById("discount-code");
      const orderForm = document.getElementById("order-form");

      // Hàm hiển thị giỏ hàng
      function displayCartItems() {
        cartItemsContainer.innerHTML = ""; // Xóa nội dung hiện tại
        if (cartItems.length === 0) {
          cartItemsContainer.innerHTML = `<p>Your cart is empty.</p>`;
          itemCountSpan.textContent = "0";
          subtotalP.textContent = "0₫";
          shippingFeeP.textContent = "-";
          totalP.textContent = "0₫";
          return;
        }

        let itemCount = 0;
        cartItems.forEach((item) => {
          const itemTotal = item.price * item.quantity;

          const itemDiv = document.createElement("div");
          itemDiv.classList.add("cart-item");

          itemDiv.innerHTML = `
            <div class="item-left">
              <img src="${item.image}" alt="${item.title}" class="cart-item-image me-3">
              <div class="item-title">
                <p class="mb-0">${item.title}</p>
                <p class="mb-0">${item.price.toLocaleString()} VND x ${item.quantity}</p>
              </div>
            </div>
            <div class="item-price">
              ${itemTotal.toLocaleString()} VND
            </div>
          `;
          cartItemsContainer.appendChild(itemDiv);

          itemCount += item.quantity;
        });

        itemCountSpan.textContent = itemCount;
        subtotalP.textContent = `${totalAmount.toLocaleString()}₫`;
        shippingFeeP.textContent = "-";
        totalP.textContent = `${(totalAmount - discount).toLocaleString()}₫`;
      }

      // Hàm áp dụng mã giảm giá
      applyDiscountButton.addEventListener("click", (e) => {
        e.preventDefault(); // Ngăn chặn hành động mặc định của nút

        const code = discountCodeInput.value.trim();
        if (code === "") {
          alert("Please enter a discount code.");
          return;
        }

        // Kiểm tra mã giảm giá (ví dụ: "DISCOUNT10" cho giảm 10%)
        if (code === "DISCOUNT10") {
          discount = totalAmount * 0.1;
          alert("Discount code applied successfully! You get a 10% discount.");
        } else if (code === "DISCOUNT20") {
          discount = totalAmount * 0.2;
          alert("Discount code applied successfully! You get a 20% discount.");
        } else {
          discount = 0;
          alert("Invalid discount code.");
        }

        totalP.textContent = `${(totalAmount - discount).toLocaleString()}₫`;
      });

      // Hàm hiển thị modal thành công
      function showOrderSuccessModal() {
        var orderSuccessModal = new bootstrap.Modal(
          document.getElementById("orderSuccessModal")
        );
        orderSuccessModal.show();
      }

      // Xử lý sự kiện submit form
      orderForm.addEventListener("submit", (e) => {
        e.preventDefault(); // Ngăn chặn submit mặc định

        if (cartItems.length === 0) {
          alert("Your cart is empty.");
          return;
        }

        // Lấy thông tin từ form
        const email = document.getElementById("email").value.trim();
        const name = document.getElementById("name").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const country = document.getElementById("country").value.trim();
        let city, district, ward, addressGeneral;
        if (country === "Vietnam") {
          city = document.getElementById("city").value.trim();
          district = document.getElementById("district").value.trim();
          ward = document.getElementById("ward").value.trim();
        } else {
          addressGeneral = document.getElementById("address-general").value.trim();
        }
        const note = document.getElementById("note").value.trim();
        const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

        // Kiểm tra các trường bắt buộc
        if (
          email === "" ||
          name === "" ||
          phone === "" ||
          note === "" ||
          (country === "Vietnam" && city === "") ||
          (country !== "Vietnam" && addressGeneral === "")
        ) {
          alert("Please fill in all required information (Email, Full Name, Phone Number, Note, Province/Address).");
          return;
        }

        // Xác thực định dạng số điện thoại (chỉ số và từ 10-15 chữ số)
        const phonePattern = /^[0-9]{10,15}$/;
        if (!phonePattern.test(phone)) {
          alert("Please enter a valid phone number (10-15 digits).");
          return;
        }

        // TODO: Thêm xử lý gửi đơn hàng đến server hoặc lưu thông tin đơn hàng

        // Hiển thị modal thành công
        showOrderSuccessModal();

        // Xóa dữ liệu giỏ hàng khỏi localStorage
        localStorage.removeItem("cartItems");
        localStorage.removeItem("totalAmount");

        // Cập nhật giao diện giỏ hàng
        displayCartItems();

        // Reset form
        orderForm.reset();
        discount = 0;
        totalP.textContent = "0₫";

        // Ẩn các trường địa chỉ
        vietnamAddress.style.display = "none";
        generalAddress.style.display = "none";
      });

      // Hàm hiển thị giỏ hàng khi tải trang
      displayCartItems();
    });

    document.addEventListener("DOMContentLoaded", () => {
      const countryCodeSelect = document.getElementById("country-code");

      // Sự kiện khi chọn mã quốc gia
      countryCodeSelect.addEventListener("change", function () {
        const selectedOption = this.options[this.selectedIndex];
        const flagUrl = selectedOption.getAttribute("data-flag");

        if (flagUrl) {
          // Thay đổi hình ảnh cờ trong dropdown
          this.style.backgroundImage = `url('${flagUrl}')`;
        } else {
          // Nếu không có cờ, loại bỏ hình ảnh nền
          this.style.backgroundImage = "none";
        }
      });

      // Khởi tạo hiển thị cờ khi tải trang
      const initialOption =
        countryCodeSelect.options[countryCodeSelect.selectedIndex];
      const initialFlag = initialOption.getAttribute("data-flag");
      if (initialFlag) {
        countryCodeSelect.style.backgroundImage = `url('${initialFlag}')`;
      }
    });
  </script>
</body>
</html>
